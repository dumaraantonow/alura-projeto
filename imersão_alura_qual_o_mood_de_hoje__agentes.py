# -*- coding: utf-8 -*-
"""ImersÃ£o Alura - Qual o mood de hoje? - Agentes

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1YKr0pspOVxytcgiZHZAi0KDgLiGoxfxC
"""

# Commented out IPython magic to ensure Python compatibility.
#Usando a biblioteca do Python

# %pip -q install google-genai

# Configura a API Key do Google Gemini

import os
from google.colab import userdata
os.environ["GOOGLE_API_KEY"] = userdata.get('GOOGLE_API_KEY')

# Configura o cliente da SDK do Gemini

from google import genai
client = genai.Client()
modelo = "gemini-2.5-flash"

# Instalar Framework de agentes do Google

!pip install -q google-adk

from google.adk.agents import Agent # Agente
from google.adk.runners import Runner # Orquestrador/Coordenador
from google.adk.sessions import InMemorySessionService # MemÃ³ria interna do orquestrador
from google.adk.tools import google_search # Ferramenta do Google Search (para poder pesquisar)
from google.genai import types  # Para criar conteÃºdos (Content e Part) / fazer as configuraÃ§Ãµes
from datetime import date
import textwrap # Para formatar melhor a saÃ­da de texto
from IPython.display import display, Markdown # Para exibir texto formatado no Colab
import requests # Para fazer requisiÃ§Ãµes HTTP
import warnings

warnings.filterwarnings("ignore")

# FunÃ§Ã£o auxiliar que envia uma mensagem para um agente via Runner e retorna a resposta final
def call_agent(agent: Agent, message_text: str) -> str:
    # Cria um serviÃ§o de sessÃ£o em memÃ³ria
    session_service = InMemorySessionService()
    # Cria uma nova sessÃ£o (vocÃª pode personalizar os IDs conforme necessÃ¡rio)
    session = session_service.create_session(app_name=agent.name, user_id="user1", session_id="session1")
    # Cria um Runner para o agente
    runner = Runner(agent=agent, app_name=agent.name, session_service=session_service)
    # Cria o conteÃºdo da mensagem de entrada
    content = types.Content(role="user", parts=[types.Part(text=message_text)])

    final_response = ""
    # Itera assincronamente pelos eventos retornados durante a execuÃ§Ã£o do agente
    for event in runner.run(user_id="user1", session_id="session1", new_message=content):
        if event.is_final_response():
          for part in event.content.parts:
            if part.text is not None:
              final_response += part.text
              final_response += "\n"
    return final_response

# FunÃ§Ã£o auxiliar para exibir texto formatado em Markdown no Colab
def to_markdown(text):
  text = text.replace('â€¢', '  *')
  return Markdown(textwrap.indent(text, '> ', predicate=lambda _: True))

####################################################
# --- Agente 1: Referencia Musical do UsuÃ¡rio --- #
####################################################
def agente_referencial (info_usuario):
  referencial = Agent(
      name="agente_referencial",
      model="gemini-2.0-flash",
      description="Agente inteligente que coleta suas preferÃªncias musicais habituais e seu humor atual para encontrar playlists perfeitas no YouTube.",
      instruction="""
      VocÃª Ã© um Agente de RecomendaÃ§Ã£o Musical Personalizada. Sua tarefa Ã© interagir com o usuÃ¡rio para entender tanto suas preferÃªncias
      musicais habituais quanto seu estado de espÃ­rito atual, a fim de encontrar playlists relevantes no YouTube. Primeiramente,
      pergunte sobre os gÃªneros musicais, artistas ou mÃºsicas que o usuÃ¡rio costuma gostar ou ouvir com frequÃªncia. Incentive-o
      a compartilhar exemplos e, se possÃ­vel, mencionar playlists que ele aprecia. Em seguida, pergunte sobre o humor ou sentimento
      que ele estÃ¡ experimentando no momento (por exemplo: feliz, relaxado, agitado, nostÃ¡lgico, etc.). Com base nas informaÃ§Ãµes
      fornecidas sobre suas preferÃªncias musicais e seu estado de espÃ­rito, vocÃª deverÃ¡ construir uma linha de raciocÃ­nio para
      conectar esses dois aspectos. Use a ferramenta de busca do Google (google_search) com foco no site youtube.com para pesquisar
      artistas, gÃªneros, playlists e como o humor pode influenciar a preferÃªncia musical. Sua resposta final deve apresentar
      uma anÃ¡lise concisa das preferÃªncias musicais e do humor do usuÃ¡rio, juntamente com sugestÃµes de artistas, mÃºsicas ou
      playlists relevantes que combinem ambos os aspectos, prontas para serem pesquisadas no YouTube.
      """,
      tools=[google_search]
  )
  entrada_do_agente_referencial = f"""
  InformaÃ§Ãµes do usuÃ¡rio:
  Estilo musical desejado: {info_usuario.get('pergunta_1', '')}
  Humor atual: {info_usuario.get('pergunta_2', '')}
  Artistas/bandas que combinam com o humor: {info_usuario.get('pergunta_3', '')}
  MÃºsica recente marcante: {info_usuario.get('pergunta_4', '')}
  Vibe musical procurada: {info_usuario.get('pergunta_5', '')}
  """
  resultados = call_agent(referencial, entrada_do_agente_referencial)
  return resultados

##########################################
# --- Agente 2: Buscador de Playlists --- #
##########################################
def agente_buscador(info_usuario, resultados_referencial):
    buscador = Agent(
        name="agente_buscador",
        model="gemini-2.0-flash",
        instruction="""
        VocÃª Ã© um Agente de Busca de Playlists Musicais no YouTube. Sua tarefa Ã© utilizar a ferramenta de busca do
        Google (google_search) com foco exclusivo no domÃ­nio youtube.com para encontrar as playlists mais relevantes
        para o usuÃ¡rio, com base nas informaÃ§Ãµes fornecidas sobre suas preferÃªncias musicais e seu estado de espÃ­rito, conforme anÃ¡lise do Agente Referencial:


        E nas informaÃ§Ãµes diretas do usuÃ¡rio:
        Estilo musical desejado:
        Humor atual:
        Artistas/bandas que combinam com o humor:
        MÃºsica recente marcante:
        Vibe musical procurada:

        Com base nessas informaÃ§Ãµes, procure no YouTube por no mÃ¡ximo 5 playlists que correspondam aos critÃ©rios do usuÃ¡rio. Priorize playlists com boa quantidade de mÃºsicas (pelo menos 10) e que
        explorem artistas similares ou relacionados, fugindo um pouco do que o usuÃ¡rio jÃ¡ costuma ouvir, mas mantendo a relevÃ¢ncia com seu gosto e humor.

        Sua resposta deve ser uma lista clara de no mÃ¡ximo 5 playlists, incluindo o link direto para cada uma delas.
        """,
        description="Encontra as melhores playlists no YouTube, combinando seu gosto musical e humor, com foco em novidades e variedade.",
        tools=[google_search]
    )

    entrada_do_agente_buscador = f"""
    AnÃ¡lise do Agente Referencial: {resultados_referencial}
    Estilo musical desejado: {info_usuario.get('pergunta_1', '')}
    Humor atual: {info_usuario.get('pergunta_2', '')}
    Artistas/bandas que combinam com o humor: {info_usuario.get('pergunta_3', '')}
    MÃºsica recente marcante: {info_usuario.get('pergunta_4', '')}
    Vibe musical procurada: {info_usuario.get('pergunta_5', '')}
    """

    playlists_encontradas = call_agent(buscador, entrada_do_agente_buscador)
    return playlists_encontradas

##########################################
# --- Agente 3: Revisor de Qualidade --- #
##########################################
def agente_revisor(info_usuario, playlists_encontradas, resultados_referencial):
    revisor = Agent(
        name="agente_revisor",
        model="gemini-2.0-flash",
        instruction="""
        VocÃª Ã© um Editor e Revisor de ConteÃºdo especializado em mÃºsica e profundo conhecedor da plataforma YouTube.
        Sua tarefa Ã© avaliar criticamente as playlists fornecidas pelo Agente Buscador, garantindo a mÃ¡xima compatibilidade
        com o estado emocional ("vibe") e as preferÃªncias musicais (gostos pessoais) previamente expressas pelo usuÃ¡rio.

        Com base na anÃ¡lise do Agente Referencial:


        E nas informaÃ§Ãµes diretas do usuÃ¡rio:
        Estilo musical desejado:
        Humor atual:
        Artistas/bandas que combinam com o humor:
        MÃºsica recente marcante:
        Vibe musical procurada:

        Playlists encontradas pelo Agente Buscador:


        Analise cada playlist individualmente, considerando os seguintes aspectos: CoerÃªncia com o Humor: As mÃºsicas e o clima
        geral da playlist refletem o estado de espÃ­rito atual do usuÃ¡rio? HÃ¡ faixas que destoam significativamente da "vibe" indicada?
        Alinhamento com as PreferÃªncias: A seleÃ§Ã£o de artistas e gÃªneros na playlist corresponde aos gostos musicais habituais do
        usuÃ¡rio? Mesmo explorando artistas relacionados, a playlist mantÃ©m uma conexÃ£o clara com suas preferÃªncias?
        Qualidade Geral: A playlist parece bem curada? As mÃºsicas fluem bem juntas? HÃ¡ alguma repetiÃ§Ã£o excessiva de artistas ou faixas?

        Se todas as playlists atenderem satisfatoriamente aos critÃ©rios de compatibilidade e qualidade, sua resposta deve ser concisa:
        "As playlists estÃ£o Ã³timas!". Caso encontre problemas em alguma playlist, seja especÃ­fico ao apontÃ¡-los e sugira melhorias
        concretas. Por exemplo, vocÃª pode sugerir a remoÃ§Ã£o de faixas que nÃ£o se encaixam no humor, a inclusÃ£o de artistas mais alinhados
        Ã s preferÃªncias, ou a busca por playlists com uma curadoria mais apurada.
        """,
        description="Garante que as playlists recomendadas no YouTube correspondam perfeitamente ao seu humor e gosto musical, oferecendo apenas o melhor.",
        tools=[google_search]
    )

    entrada_do_agente_revisor = f"""
    AnÃ¡lise do Agente Referencial: {resultados_referencial}
    Estilo musical desejado: {info_usuario.get('pergunta_1', '')}
    Humor atual: {info_usuario.get('pergunta_2', '')}
    Artistas/bandas que combinam com o humor: {info_usuario.get('pergunta_3', '')}
    MÃºsica recente marcante: {info_usuario.get('pergunta_4', '')}
    Vibe musical procurada: {info_usuario.get('pergunta_5', '')}
    Playlists encontradas: {playlists_encontradas}
    """

    playlists_revisadas = call_agent(revisor, entrada_do_agente_revisor)
    return playlists_revisadas

print("NÃ£o sabe que musicas ouvir hoje? Vem que esses 3 agentes vÃ£o lhe ajudar! ğŸ¶ ğŸ˜Š ")
print("\n")
print("Primeiramente: precisamos conhecer um pouco sobre vocÃª e o que voce gosta de ouvir!")
print("\n")

# --- Obter as ReferÃªncias Musicais e Humor do UsuÃ¡rio ---
info_usuario = {}
cont = 0
num_perguntas = 5

perguntas_usuario = [
    "Qual estilo ou gÃªnero musical vocÃª estÃ¡ com mais vontade de ouvir agora?",
    "Como vocÃª estÃ¡ se sentindo neste momento? (ex: feliz, relaxado, agitado, nostÃ¡lgico...)",
    "Pensando em artistas ou bandas que vocÃª gosta, algum deles combina com o seu humor de hoje?",
    "Tem alguma mÃºsica que vocÃª ouviu recentemente que te marcou ou que reflete como vocÃª estÃ¡ se sentindo?",
    "AlÃ©m dos seus gostos habituais, existe algum tipo de 'vibe' musical especÃ­fica que vocÃª procura para hoje?"
]

# Criando um chat bot curto para o primeiro agente ter as informaÃ§Ãµes que precisa
while cont < num_perguntas:
    resposta = input(f"{perguntas_usuario[cont]} ")
    info_usuario[f"pergunta_{cont+1}"] = resposta
    cont += 1

print("\nObrigado pelas informaÃ§Ãµes!")
print("Suas respostas:", info_usuario)
print("\n")

# --- PrÃ³ximos passos (envio para os agentes) ---

# --- PrÃ³ximos passos (envio para os agentes) ---

# --- Executar os agentes ---

print(f"Maravilha! Vamos agora descobrir suas playlists!")


resultados_referencial = agente_referencial(info_usuario)
print("\n--- ğŸ“ Resultado do Agente 1 (Referencial) ---\n")
display(to_markdown(resultados_referencial))
print("--------------------------------------------------------------")


playlists_encontradas = agente_buscador(info_usuario, resultados_referencial)
print("\n--- ğŸ“ Resultado do Agente 2 (Buscador) ---\n")
display(to_markdown(playlists_encontradas))
print("--------------------------------------------------------------")


post_final = agente_revisor(info_usuario, playlists_encontradas, resultados_referencial)
print("\n--- ğŸ“ Resultado do Agente 3 (Revisor) ---\n")
display(to_markdown(post_final))
print("--------------------------------------------------------------")